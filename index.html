<!DOCTYPE html>
<html>
<head>
<title>T&O Allocation Tool</title>
<style>
body {
    font-family: Arial, sans-serif;
    margin: 40px;
}

h1 {
    margin-bottom: 10px;
}

.section {
    margin-top: 30px;
}

input, select {
    padding: 6px;
    width: 180px;
    text-align: right;
}

input[readonly] {
    background-color: #f2f2f2;
}

.service-row {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 10px;
}

.label {
    width: 200px;
    text-align: left;
}

.percent {
    width: 80px;
}

table {
    border-collapse: collapse;
    margin-top: 20px;
    width: 700px;
}

th, td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: right;
}

th {
    background-color: #f5f5f5;
}

td:first-child, th:first-child {
    text-align: left;
}

.not-applicable {
    background-color: #f3f3f3;
    font-weight: bold;
}
</style>
</head>

<body>

<h1>T&O Allocation Tool</h1>

<div>
<label><strong>Units:</strong></label>
<select id="unitSelect" onchange="changeUnit()">
<option value="1">Actual</option>
<option value="1000">Thousands</option>
<option value="1000000">Millions</option>
</select>
</div>

<div class="section">
<h2>Enter Service Revenues</h2>

<div class="service-row">
<div class="label">Strategy & Consulting (S&C)</div>
<input type="text" id="scRevenue" oninput="calculate()" />
<div class="percent" id="scPercent">0%</div>
</div>

<div class="service-row">
<div class="label">Technology</div>
<input type="text" id="techRevenue" oninput="calculate()" />
<div class="percent" id="techPercent">0%</div>
</div>

<div class="service-row">
<div class="label">Operations</div>
<input type="text" id="opsRevenue" oninput="calculate()" />
<div class="percent" id="opsPercent">0%</div>
</div>

<div class="service-row">
<div class="label"><strong>Total Contract Revenue</strong></div>
<input type="text" id="totalRevenue" readonly />
<div class="percent"><strong>100%</strong></div>
</div>

</div>

<div class="section">
<h2>T&O Revenue Summary</h2>

<div class="service-row">
<div class="label">T&O Revenue</div>
<input type="text" id="tnORevenue" readonly />
<div class="percent" id="tnOPercent">0%</div>
</div>

<div style="margin-top:10px;">
<strong>T&O Allocation % required to meet S&C Revenues = 
<span id="allocationPercent">0%</span>
</strong>
</div>

</div>

<div class="section">
<h2>Select Capabilities</h2>

<select id="capabilities" multiple size="5" onchange="buildCapabilityTable()">
<option>Change & Human Experience</option>
<option>HRT</option>
<option>Learning & Skilling</option>
<option>OM&OD</option>
<option>TS&D</option>
</select>

<table id="capTable" style="display:none;">
<thead>
<tr>
<th>Capability</th>
<th>% T&O Revenue</th>
<th>Total Contract Revenue</th>
</tr>
</thead>
<tbody id="capBody">
</tbody>
</table>

</div>

<script>

let currentUnit = 1;

function parseNumber(val){
    return parseFloat(val.replace(/,/g,'')) || 0;
}

function formatNumber(val){
    return val.toLocaleString(undefined, {maximumFractionDigits:0});
}

function changeUnit(){
    currentUnit = parseFloat(document.getElementById("unitSelect").value);
    calculate();
}

function calculate(){

    let sc = parseNumber(document.getElementById("scRevenue").value) * currentUnit;
    let tech = parseNumber(document.getElementById("techRevenue").value) * currentUnit;
    let ops = parseNumber(document.getElementById("opsRevenue").value) * currentUnit;

    let total = sc + tech + ops;

    document.getElementById("totalRevenue").value = formatNumber(total/currentUnit);

    if(total === 0){
        document.getElementById("scPercent").innerText = "0%";
        document.getElementById("techPercent").innerText = "0%";
        document.getElementById("opsPercent").innerText = "0%";
        document.getElementById("tnORevenue").value = "0";
        document.getElementById("tnOPercent").innerText = "0%";
        document.getElementById("allocationPercent").innerText = "0%";
        return;
    }

    let scPct = (sc/total)*100;
    let techPct = (tech/total)*100;
    let opsPct = (ops/total)*100;

    document.getElementById("scPercent").innerText = scPct.toFixed(1)+"%";
    document.getElementById("techPercent").innerText = techPct.toFixed(1)+"%";
    document.getElementById("opsPercent").innerText = opsPct.toFixed(1)+"%";

    let tnO = tech + ops;
    let tnOPct = (tnO/total)*100;

    document.getElementById("tnORevenue").value = formatNumber(tnO/currentUnit);
    document.getElementById("tnOPercent").innerText = tnOPct.toFixed(1)+"%";
    document.getElementById("allocationPercent").innerText = tnOPct.toFixed(1)+"%";

    updateCapabilityTable(tnO, tnOPct);
}

function buildCapabilityTable(){
    let select = document.getElementById("capabilities");
    let selected = Array.from(select.selectedOptions).map(o=>o.value);

    let tbody = document.getElementById("capBody");
    tbody.innerHTML = "";

    if(selected.length === 0){
        document.getElementById("capTable").style.display="none";
        return;
    }

    document.getElementById("capTable").style.display="table";

    let equalPercent = 100/selected.length;

    selected.forEach(cap=>{
        let row = document.createElement("tr");

        row.innerHTML = `
        <td>${cap}</td>
        <td><input type="number" value="${equalPercent.toFixed(1)}" oninput="capPercentChanged()" style="width:80px;">%</td>
        <td class="capRevenue">0</td>
        `;

        tbody.appendChild(row);
    });

    // Add Not Applicable row
    let row = document.createElement("tr");
    row.className="not-applicable";
    row.innerHTML=`
        <td>Not Applicable</td>
        <td id="notApplicablePercent">0%</td>
        <td id="notApplicableRevenue">0</td>
    `;
    tbody.appendChild(row);

    calculate();
}

function capPercentChanged(){
    calculate();
}

function updateCapabilityTable(tnORevenue, tnOPct){

    let table = document.getElementById("capTable");
    if(table.style.display==="none") return;

    let rows = document.querySelectorAll("#capBody tr");
    let allowedPercent = tnOPct;

    let totalUsed = 0;

    rows.forEach((row,index)=>{
        if(index === rows.length-1) return; // skip Not Applicable
        let input = row.querySelector("input");
        let pct = parseFloat(input.value)||0;
        totalUsed += pct;
    });

    if(totalUsed > allowedPercent){
        alert("Total capability % cannot exceed T&O Allocation %");
        return;
    }

    rows.forEach((row,index)=>{
        if(index === rows.length-1) return;
        let input = row.querySelector("input");
        let pct = parseFloat(input.value)||0;
        let revenue = tnORevenue * (pct/allowedPercent);
        row.querySelector(".capRevenue").innerText = formatNumber(revenue/currentUnit);
    });

    let remaining = allowedPercent - totalUsed;
    if(remaining < 0) remaining = 0;

    document.getElementById("notApplicablePercent").innerText = remaining.toFixed(1)+"%";
    let notAppRevenue = tnORevenue * (remaining/allowedPercent);
    document.getElementById("notApplicableRevenue").innerText = formatNumber(notAppRevenue/currentUnit);
}

</script>

</body>
</html>
